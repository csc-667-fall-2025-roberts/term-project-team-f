{"version":3,"file":"chat.js","sources":["../../../shared/chat-keys.ts","../../../frontend/chat.ts"],"sourcesContent":["const CHAT_MESSAGE = (id: number = 0) => `chat:${id}:message`;\nconst CHAT_LISTING = (id: number = 0) => `chat:${id}:listing`;\n\nexport { CHAT_LISTING, CHAT_MESSAGE };\n","import socketIo from \"socket.io-client\";\nimport type { ChatMessage } from \"../shared/types\";\nimport * as messageKeys from \"../shared/chat-keys\";\n\n// Use GAME_ID from window (same as Game.ts)\ndeclare global {\n  interface Window {\n    GAME_ID?: number;\n  }\n}\n\nconst socket = socketIo();\n\nconst listing = document.querySelector<HTMLDivElement>(\"#message-listing\");\nconst messageText = document.querySelector<HTMLInputElement>(\n  \"#messsage-submit input\",\n);\nconst submitButton = document.querySelector<HTMLButtonElement>(\n  \"#messsage-submit button\",\n);\n\n// Guard clause - exit if elements don't exist (e.g., on pages without chat)\nif (!listing || !messageText || !submitButton) {\n  // Chat elements not found on this page\n} else {\n  let isFirstMessage = true;\n  let socketListenersInitialized = false;\n\n  const appendMessage = (username: string, timestamp: Date, message: string) => {\n    // Clear placeholder on first message\n    if (isFirstMessage) {\n      listing.innerHTML = \"\";\n      isFirstMessage = false;\n    }\n\n    const messageDiv = document.createElement(\"div\");\n    messageDiv.className = \"chat-message\";\n\n    const time = new Date(timestamp).toLocaleTimeString([], {\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n    });\n\n    messageDiv.innerHTML = `\n      <div class=\"chat-message-content\">\n        <div class=\"chat-message-author\">${username}</div>\n        <span>${message}</span>\n        <span style=\"font-size: 0.75rem; color: var(--color-gray-500); margin-left: 0.5rem;\">${time}</span>\n      </div>\n    `;\n    listing.appendChild(messageDiv);\n    listing.scrollTop = listing.scrollHeight;\n  };\n\n  // Join appropriate room (lobby or game) and load existing messages\n  // GAME_ID is always defined (0 for lobby, game.id for game pages)\n  const gameId = typeof window.GAME_ID !== \"undefined\" ? window.GAME_ID : 0;\n  \n  // Always join room and load messages (lobby uses gameId = 0)\n  socket.emit(\"joinGameRoom\", gameId);\n  \n  // Only register socket listeners once to prevent duplicates\n  if (!socketListenersInitialized) {\n    socketListenersInitialized = true;\n    \n    socket.on(\n      messageKeys.CHAT_LISTING(gameId),\n      ({ messages }: { messages: ChatMessage[] }) => {\n        messages.forEach((msg) => {\n          appendMessage(msg.username, msg.created_at, msg.message);\n        });\n      },\n    );\n\n    socket.on(messageKeys.CHAT_MESSAGE(gameId), (msg: ChatMessage) => {\n      appendMessage(msg.username, msg.created_at, msg.message);\n    });\n  }\n  \n  // Load existing messages\n  fetch(`/chat/${gameId}`)\n    .then((res) => {\n      if (!res.ok) {\n        throw new Error(`Failed to load messages: ${res.status}`);\n      }\n      return res.json();\n    })\n    .then((data) => {\n      if (data.messages && Array.isArray(data.messages)) {\n        data.messages.forEach((msg: ChatMessage) => {\n          appendMessage(msg.username, msg.created_at, msg.message);\n        });\n      }\n    })\n    .catch((err) => console.error(\"Failed to load messages:\", err));\n\n  const sendMessage = () => {\n    const message = messageText.value.trim();\n\n    if (message.length > 0) {\n      fetch(`/chat/${gameId}`, {\n        method: \"POST\",\n        body: JSON.stringify({ message }),\n        credentials: \"include\",\n        headers: { \"Content-Type\": \"application/json\" },\n      })\n        .then((res) => {\n          if (!res.ok) {\n            console.error(\"Failed to send message:\", res.status);\n          }\n        })\n        .catch((err) => {\n          console.error(\"Error sending message:\", err);\n        });\n      messageText.value = \"\";\n    }\n  };\n\n  submitButton.addEventListener(\"click\", (event) => {\n    event.preventDefault();\n    sendMessage();\n  });\n\n  messageText.addEventListener(\"keydown\", (event) => {\n    if (event.key === \"Enter\") {\n      event.preventDefault();\n      sendMessage();\n    }\n  });\n}\n"],"names":["CHAT_MESSAGE","id","CHAT_LISTING","socket","socketIo","listing","messageText","submitButton","isFirstMessage","socketListenersInitialized","appendMessage","username","timestamp","message","messageDiv","time","gameId","messageKeys.CHAT_LISTING","messages","msg","messageKeys.CHAT_MESSAGE","res","data","err","sendMessage","event"],"mappings":"gDAAA,MAAMA,EAAe,CAACC,EAAa,IAAM,QAAQA,CAAE,WAC7CC,EAAe,CAACD,EAAa,IAAM,QAAQA,CAAE,WCU7CE,EAASC,EAAA,EAETC,EAAU,SAAS,cAA8B,kBAAkB,EACnEC,EAAc,SAAS,cAC3B,wBACF,EACMC,EAAe,SAAS,cAC5B,yBACF,EAGA,GAAI,GAACF,GAAW,CAACC,GAAe,CAACC,GAE1B,CACL,IAAIC,EAAiB,GACjBC,EAA6B,GAEjC,MAAMC,EAAgB,CAACC,EAAkBC,EAAiBC,IAAoB,CAExEL,IACFH,EAAQ,UAAY,GACpBG,EAAiB,IAGnB,MAAMM,EAAa,SAAS,cAAc,KAAK,EAC/CA,EAAW,UAAY,eAEvB,MAAMC,EAAO,IAAI,KAAKH,CAAS,EAAE,mBAAmB,CAAA,EAAI,CACtD,KAAM,UACN,OAAQ,SAAA,CACT,EAEDE,EAAW,UAAY;AAAA;AAAA,2CAEgBH,CAAQ;AAAA,gBACnCE,CAAO;AAAA,+FACwEE,CAAI;AAAA;AAAA,MAG/FV,EAAQ,YAAYS,CAAU,EAC9BT,EAAQ,UAAYA,EAAQ,YAC9B,EAIMW,EAAS,OAAO,OAAO,QAAY,IAAc,OAAO,QAAU,EAGxEb,EAAO,KAAK,eAAgBa,CAAM,EAG7BP,IACHA,EAA6B,GAE7BN,EAAO,GACLc,EAAyBD,CAAM,EAC/B,CAAC,CAAE,SAAAE,CAAA,IAA4C,CAC7CA,EAAS,QAASC,GAAQ,CACxBT,EAAcS,EAAI,SAAUA,EAAI,WAAYA,EAAI,OAAO,CACzD,CAAC,CACH,CAAA,EAGFhB,EAAO,GAAGiB,EAAyBJ,CAAM,EAAIG,GAAqB,CAChET,EAAcS,EAAI,SAAUA,EAAI,WAAYA,EAAI,OAAO,CACzD,CAAC,GAIH,MAAM,SAASH,CAAM,EAAE,EACpB,KAAMK,GAAQ,CACb,GAAI,CAACA,EAAI,GACP,MAAM,IAAI,MAAM,4BAA4BA,EAAI,MAAM,EAAE,EAE1D,OAAOA,EAAI,KAAA,CACb,CAAC,EACA,KAAMC,GAAS,CACVA,EAAK,UAAY,MAAM,QAAQA,EAAK,QAAQ,GAC9CA,EAAK,SAAS,QAASH,GAAqB,CAC1CT,EAAcS,EAAI,SAAUA,EAAI,WAAYA,EAAI,OAAO,CACzD,CAAC,CAEL,CAAC,EACA,MAAOI,GAAQ,QAAQ,MAAM,2BAA4BA,CAAG,CAAC,EAEhE,MAAMC,EAAc,IAAM,CACxB,MAAMX,EAAUP,EAAY,MAAM,KAAA,EAE9BO,EAAQ,OAAS,IACnB,MAAM,SAASG,CAAM,GAAI,CACvB,OAAQ,OACR,KAAM,KAAK,UAAU,CAAE,QAAAH,EAAS,EAChC,YAAa,UACb,QAAS,CAAE,eAAgB,kBAAA,CAAmB,CAC/C,EACE,KAAMQ,GAAQ,CACRA,EAAI,IACP,QAAQ,MAAM,0BAA2BA,EAAI,MAAM,CAEvD,CAAC,EACA,MAAOE,GAAQ,CACd,QAAQ,MAAM,yBAA0BA,CAAG,CAC7C,CAAC,EACHjB,EAAY,MAAQ,GAExB,EAEAC,EAAa,iBAAiB,QAAUkB,GAAU,CAChDA,EAAM,eAAA,EACND,EAAA,CACF,CAAC,EAEDlB,EAAY,iBAAiB,UAAYmB,GAAU,CAC7CA,EAAM,MAAQ,UAChBA,EAAM,eAAA,EACND,EAAA,EAEJ,CAAC,CACH"}